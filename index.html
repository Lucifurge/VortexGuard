<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
  const map = L.map('world-map', {
    zoomControl: false,
    preferCanvas: true
  }).setView([20, 0], 2);

  // âœ… FIXED DARK MAP (NO API KEY)
  L.tileLayer(
    'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
    {
      subdomains: 'abcd',
      maxZoom: 19
    }
  ).addTo(map);

  // DEFENDED NODES
  const nodes = [
    { name: 'San Francisco Core', coords: [37.7749, -122.4194] },
    { name: 'London Web Cluster', coords: [51.5074, -0.1278] },
    { name: 'Tokyo Defense Node', coords: [35.6895, 139.6917] },
    { name: 'Singapore Edge', coords: [1.3521, 103.8198] },
    { name: 'New York Backbone', coords: [40.7128, -74.0060] },
  ];

  // ATTACK SOURCES (FAKE GEO-IP)
  const attackers = [
    { name: 'Eastern Europe Botnet', coords: [50, 30] },
    { name: 'China Botnet', coords: [35, 105] },
    { name: 'Brazil Botnet', coords: [-10, -55] }
  ];

  const markers = [];

  nodes.forEach(n => {
    const marker = L.circleMarker(n.coords, {
      radius: 8,
      color: '#22c55e',
      fillColor: '#22c55e',
      fillOpacity: 0.9
    }).addTo(map)
      .bindPopup(`<b>${n.name}</b><br>Status: Protected`);

    markers.push(marker);
  });

  const logBox = document.getElementById('log-box');
  function log(msg) {
    const t = new Date().toLocaleTimeString();
    const p = document.createElement('p');
    p.textContent = `[${t}] ${msg}`;
    logBox.prepend(p);
  }

  // ðŸ”´ ATTACK ANIMATION
  function simulateAttack(from, to) {
    const line = L.polyline([from, to], {
      color: '#ef4444',
      weight: 2,
      dashArray: '5,10'
    }).addTo(map);

    const impact = L.circleMarker(to, {
      radius: 6,
      color: '#ef4444',
      fillOpacity: 0.7
    }).addTo(map);

    setTimeout(() => {
      map.removeLayer(line);
      map.removeLayer(impact);
    }, 2000);
  }

  document.getElementById('simulate').onclick = () => {
    log('âš  Massive DDoS wave detected from Eastern Europe');
    log('âš  SQL Injection blocked on London Web Cluster');
    log('âš  Botnet traffic neutralized at Tokyo Defense Node');

    attackers.forEach((attacker, i) => {
      const target = nodes[i % nodes.length];
      simulateAttack(attacker.coords, target.coords);
    });

    markers.forEach(m => {
      m.setStyle({ color: '#ef4444', fillColor: '#ef4444' });
      setTimeout(() => m.setStyle({ color: '#22c55e', fillColor: '#22c55e' }), 2000);
    });
  };

  // CHART
  const ctx = document.getElementById('attackChart');
  new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: ['DDoS', 'Malware', 'Bruteforce', 'SQLi'],
      datasets: [{
        data: [42, 23, 18, 17],
        backgroundColor: ['#ef4444', '#f97316', '#eab308', '#38bdf8']
      }]
    },
    options: {
      plugins: { legend: { labels: { color: '#e5e7eb' } } }
    }
  });
</script>
